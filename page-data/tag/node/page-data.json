{"componentChunkName":"component---src-templates-tags-jsx","path":"/tag/node","result":{"data":{"site":{"siteMetadata":{"title":"Ken Powers"}}},"pageContext":{"posts":[{"html":"<p><em>Partially applied functions</em>, or <em>partials</em> for short, are functions with\npre-set arguments. The use of partials is very common in functional\nprogramming and has been implemented in several JavaScript libraries and more\nrecently in ECMAScript 5 through <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind\" title=\"Function.prototype.bind\"><code class=\"language-text\">Function.prototype.bind</code></a>. Consider\nthe following examples:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Adds two numbers</span>\n<span class=\"token keyword\">var</span> <span class=\"token function-variable function\">add</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Let's make some partials!</span>\n<span class=\"token comment\">// Underscore.js</span>\n<span class=\"token keyword\">var</span> addTwo <span class=\"token operator\">=</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">partial</span><span class=\"token punctuation\">(</span>add<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Dojo.js</span>\n<span class=\"token keyword\">var</span> addFour <span class=\"token operator\">=</span> lang<span class=\"token punctuation\">.</span><span class=\"token function\">partial</span><span class=\"token punctuation\">(</span>add<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// JavaScript 1.8.5</span>\n<span class=\"token keyword\">var</span> addSix <span class=\"token operator\">=</span> <span class=\"token function\">add</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Let's use our partials!</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">addTwo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Logs 3</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">addFour</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Logs 7</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">addSix</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Logs 11</span></code></pre></div>\n<p>In each of the above examples the original function is not modified -- rather,\na new function is created which calls the original function by concatenating\nthe pre-defined arguments with the call-time arguments. JavaScript's\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind\" title=\"Function.prototype.bind\"><code class=\"language-text\">bind</code></a> works a little differently from Underscore's\n<a href=\"http://underscorejs.org/#partial\" title=\"Underscore.js - Partial\"><code class=\"language-text\">_.partial</code></a> and Dojo's <a href=\"http://dojotoolkit.org/reference-guide/1.9/dojo/_base/lang.html#partial\" title=\"Dojo lang.partial\"><code class=\"language-text\">lang.partial</code></a> in that its\nfirst argument becomes the value of <code class=\"language-text\">this</code> when the function is called. You\nwill need to use this if you are partially applying instance methods.\nUnderscore and Dojo provide similar functionality through <a href=\"http://underscorejs.org/#bind\" title=\"Underscore.js - Bind\"><code class=\"language-text\">_.bind</code></a>\nand <a href=\"http://dojotoolkit.org/reference-guide/1.9/dojo/_base/lang.html#hitch\" title=\"Dojo lang.hitch\"><code class=\"language-text\">lang.hitch</code></a> respectively. For the sake of simplicity, these\nfunctions will not be covered here.</p>\n<p>How about a more practical example? <a href=\"http://nodejs.org/\" title=\"Node.js\">Node.js</a> follows a convention for\nall asynchronous callbacks -- they are expected to take an error argument\nfollowed by a result argument. <a href=\"https://github.com/caolan/async\" title=\"Async.js\">Async.js</a>, a library which provides\nfunctions for dealing with asynchronous control flow and collection\nmanipulation, builds upon this convention with functions like\n<a href=\"https://github.com/caolan/async#parallel\" title=\"Async.js - parallel\"><code class=\"language-text\">parallel</code></a> and <a href=\"https://github.com/caolan/async#series\" title=\"Async.js - series\"><code class=\"language-text\">series</code></a> which take arrays of functions\nthat in turn take nothing but these conventional callbacks. Consider the\nfollowing examples:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Without partials</span>\nasync<span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token comment\">// `done` accepts err, result</span>\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bar.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> results</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// err is the first thrown / passed error</span>\n  <span class=\"token comment\">// results is an array of results</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// With async's own partial implementation</span>\nasync<span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token function\">async</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span>readFile<span class=\"token punctuation\">,</span> <span class=\"token string\">'foo.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">async</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span>readFile<span class=\"token punctuation\">,</span> <span class=\"token string\">'bar.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> results</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// same as before</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Async provides its own partial implementation by the name of <a href=\"https://github.com/caolan/async#apply\" title=\"Async.js - apply\"><code class=\"language-text\">apply</code></a>\nwhich is very similar to Underscore's implementation. By partially applying\n<code class=\"language-text\">fs.readFile</code> we are able to shorten the function signature from <code class=\"language-text\">filename,\nencoding, callback</code> to just <code class=\"language-text\">callback</code> enabling us to make an array of\npartials rather than manually declaring functions as in the first example.</p>\n<p>As a side note, you may have noticed that the last argument to\n<code class=\"language-text\">Async.parallel</code> is a Node-style callback. If you felt so inclined, you could\npartially apply <code class=\"language-text\">Async.parallel</code> and <code class=\"language-text\">Async.series</code> and pass those partials to\nother calls to <code class=\"language-text\">Async.parallel</code> and <code class=\"language-text\">Async.series</code>, as such:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">async<span class=\"token punctuation\">.</span><span class=\"token function\">series</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token function\">async</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">.</span>parallel<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// First group of parallel tasks</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">async</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">.</span>parallel<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// Second group of parallel tasks</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> results</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// err is the same as always</span>\n  <span class=\"token comment\">// results is an array of arrays</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This code will run a group of tasks in parallel and when they are all done run\na second group of tasks in parallel. The final <code class=\"language-text\">results</code> array will be an\narray of arrays where each internal array contains the results of each group\nof tasks. You can easily change up this example to run two groups of serial\ntasks in parallel by changing all calls to <code class=\"language-text\">series</code> with <code class=\"language-text\">parallel</code> and vice\nversa. This will work for most functions provided by Async.</p>\n<p>On to a more practical example, can we read a bunch of files in parallel and\nonly have to write <code class=\"language-text\">async.apply</code> once? Of course! Enter\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map\" title=\"Array.prototype.map\"><code class=\"language-text\">Array.prototype.map</code></a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">async<span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token string\">'first.txt'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'second.txt'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'foo.txt'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'bar.txt'</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">file</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">async</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span>readFile<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> results</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Same as before.</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In this example calling <code class=\"language-text\">map</code> on the array of file names returns an array of\npartially applied <code class=\"language-text\">fs.readfile</code> functions. Using this technique you can\ndynamically create a list of files and read them all into memory. Want to\nlimit the amount of files being read at once? That's what\n<a href=\"https://github.com/caolan/async#parallellimittasks-limit-callback\" title=\"Async.js - parallelLimit\"><code class=\"language-text\">parallelLimit</code></a> is for.</p>\n<h2>Limitations</h2>\n<p>So partials are pretty cool. But you have to be careful about how you use them\n(in JavaScript). In particular things can get tricky when you partially apply\nfunctions which take more arguments than you intend on passing. Consider the\nfollowing:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// This function multiplies all of its arguments together</span>\n<span class=\"token keyword\">var</span> <span class=\"token function-variable function\">multiply</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prev<span class=\"token punctuation\">,</span> cur</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> prev <span class=\"token operator\">*</span> cur<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// This function multiplies all of its arguments by each other and 2</span>\n<span class=\"token keyword\">var</span> mult2 <span class=\"token operator\">=</span> <span class=\"token function\">multiply</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// You might expect this to log [2, 4, 6, 8], but it actually logs [NaN, NaN, NaN, NaN]</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>mult2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// The solution is to explicity call mult2 with the arguments you want to pass</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">v</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">mult2</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Really, it's not fair to call this a limitation of partials but JavaScript\nfunctions in general -- we would have gotten a similar result had we not made\na partial. In my experience this problem appears more often when I am using\npartials than when I'm not. What is happening here is that the function passed\nto <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map\" title=\"Array.prototype.map\"><code class=\"language-text\">map</code></a> takes three arguments: <code class=\"language-text\">value</code>, <code class=\"language-text\">index</code>, and <code class=\"language-text\">array</code>. Our\nintention is to map each <code class=\"language-text\">value</code> to <code class=\"language-text\">2 * value</code> but instead we end up with\n<code class=\"language-text\">2 * value * index * array</code>. The solution is to explicitly pass the arguments\nyou want into the partial.</p>\n<p>Another point to note is that partials usually have a <code class=\"language-text\">length</code> of <code class=\"language-text\">0</code>. This\nmeans that they are declared without an arguments list. They still take\narguments but anything that checks for a partial's <code class=\"language-text\">length</code> property will more\nthan likely malfunction. For example, asynchronous tests in Mocha:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Some sort of function is declared somewhere as such:</span>\n<span class=\"token keyword\">var</span> <span class=\"token function-variable function\">asyncFunc</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// do something and call callback per node convention;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// It may be tempting to test it in Mocha as such since the async callback</span>\n<span class=\"token comment\">// will fail the test if an error is passed:</span>\n<span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should do something without error'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">asyncFunc</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'foobarbaz'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// DON'T DO THIS!</span>\n\n<span class=\"token comment\">// However, since the partial doesn't have a `length` property the test will</span>\n<span class=\"token comment\">// complete immediately and the callback will be undefined. The solution is to</span>\n<span class=\"token comment\">// explicity declare async test functions:</span>\n<span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should do something without error'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">asyncFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foobarbaz'</span><span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>To learn more about testing with Mocha check out <a href=\"/blog/testing-in-browsers-and-node/\" title=\"Testing in Browsers and Node with Mocha, Chai, Sinon, and Testem\">my article on the\nsubject</a> and the <a href=\"http://visionmedia.github.io/mocha/\" title=\"Mocha\">official Mocha documentation</a>.</p>\n<h2>Kinda Partial-Like Things</h2>\n<p>Throughout JavaScript and JavaScript libraries you will find various functions\nwhich take a function as an argument as well as a parameter list to pass to\nthe function. They aren't returning a partial for you to use, but they are an\nopportunity for you to avoid the creation of a partial if you don't have to\nmake one. Take for example <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window.setTimeout\" title=\"MDN - setTimeout\"><code class=\"language-text\">setTimeout</code></a> and\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window.setInterval\" title=\"MDN - setInterval\"><code class=\"language-text\">setInterval</code></a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Consider the following:</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">,</span> bar<span class=\"token punctuation\">,</span> baz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// You may think to compress it with a partial as such:</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> foo<span class=\"token punctuation\">,</span> bar<span class=\"token punctuation\">,</span> baz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// But this isn't really necessary. The following does the same thing:</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>doSomething<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> foo<span class=\"token punctuation\">,</span> bar<span class=\"token punctuation\">,</span> baz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// It also works with setInterval:</span>\n<span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span>doSomething<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> foo<span class=\"token punctuation\">,</span> bar<span class=\"token punctuation\">,</span> baz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In compliant JavaScript environments, the extra arguments passed to\n<code class=\"language-text\">setTimeout</code> and <code class=\"language-text\">setInterval</code> are passed to the function when it is called.\nBe careful as you can't specify a context this way -- you will have to rely on\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind\" title=\"Function.prototype.bind\"><code class=\"language-text\">Function.prototype.bind</code></a>, <a href=\"http://underscorejs.org/#bind\" title=\"Underscore.js - Bind\"><code class=\"language-text\">_.bind</code></a>, and\n<a href=\"http://dojotoolkit.org/reference-guide/1.9/dojo/_base/lang.html#hitch\" title=\"Dojo lang.hitch\"><code class=\"language-text\">lang.hitch</code></a> for that.</p>\n<h2>Conclusion</h2>\n<p>Using partials to adapt existing functions to match a given convention is a\nvery powerful technique. <a href=\"https://github.com/caolan/async\" title=\"Async.js\">Async</a> provides more functions which when\ncombined with <a href=\"http://nodejs.org/\" title=\"Node.js\">Node</a> conventions and partials can lead to very concise,\nreadable, and maintainable code. That being said, you will still have to be\ncareful in situations where arguments don't match up properly or where you\nneed to specify a special context for the partially applied function.</p>","id":"3e8cddb0-bf39-55fc-b9f0-f0eecf02dfb3","timeToRead":7,"frontmatter":{"date":"December 14, 2013","path":"/blog/the-power-and-limitations-of-partials","tags":"javascript, node","title":"The Power and Limitations of Partials"}},{"html":"<p>So you're writing some JavaScript code that has to run in multiple web\nbrowsers as well as Node. How can you effectively test this code? Effective\ntesting means that you should be able to run all tests in all environments on\ndemand, i.e., with the press of a single button the tests should run in Node,\nChrome, Firefox, Internet Explorer, and whatever other environments you have\nset up for testing, and we should avoid code duplication whenever possible.\nContinue reading and I'll walk you through setting up a basic testing\nenvironment using <a href=\"http://visionmedia.github.io/mocha/\" title=\"Mocha\">Mocha</a> as a testing framework, <a href=\"http://chaijs.com/\" title=\"Chai\">Chai</a> for\nassertions, <a href=\"http://sinonjs.org/\" title=\"Sinon\">Sinon</a> for mocking, and <a href=\"https://github.com/airportyh/testem\" title=\"Testem\">Testem</a> as a universal\ntest runner. Basic knowledge of testing, asserting, and mocking in languages\nother than JavaScript is assumed. Those of you who are familiar with testing,\nasserting, and mocking in JavaScript will want to <a href=\"#testem\">skip to the\nTestem</a> section below -- that's where the meat and potatoes of\npulling everything together into a working example is.</p>\n<h2>Mocha</h2>\n<p><a href=\"http://visionmedia.github.io/mocha/\" title=\"Mocha\">Mocha</a> is a testing framework for JavaScript which provides a\nflexible, intuitive, and consistent interface for testing JavaScript code,\nboth synchronous and asynchronous. Additionally, it is designed to run in both\nmajor browsers and Node.</p>\n<p>Without further to do, a basic test suite looks like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Library Tests'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// set up the environment</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Should add numbers'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// make assertions</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The above code should be fairly self-explanatory. <code class=\"language-text\">describe</code> is used to\ndescribe a test suite, and <code class=\"language-text\">it</code> is used to define actual tests. I am also\nmaking use of a <code class=\"language-text\">before</code> hook to set up the environment prior to running any\ntests. In addition to the <code class=\"language-text\">before</code> hook, Mocha makes available the <code class=\"language-text\">after</code>\nhook, which executes after all tests have run. The <code class=\"language-text\">before</code> and <code class=\"language-text\">after</code> hooks\nadditionally have <code class=\"language-text\">beforeEach</code> and <code class=\"language-text\">afterEach</code> counterparts, which, as their\nnames imply, rather than running before or after all tests run before and\nafter each individual test.</p>\n<h3>Asynchronous Testing</h3>\n<p>One of the advantages of using Mocha as opposed to certain other testing\nframeworks is that it makes asynchronous testing really easy. Consider the\nfollowing test:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should foobar'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Simulate calling an asynchronous method with `setTimeout`</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Make assertions</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The only change to the test is that the <code class=\"language-text\">it</code> function now accepts a <code class=\"language-text\">done</code>\nargument. <code class=\"language-text\">done</code> is a function you should call when the test has completed\n(after all assertions). Additionally, <code class=\"language-text\">done</code> accepts an <code class=\"language-text\">Error</code> object as its\nfirst argument if you have one to give it. The previously mentioned <code class=\"language-text\">before</code>,\n<code class=\"language-text\">beforeEach</code>, <code class=\"language-text\">after</code>, and <code class=\"language-text\">afterEach</code> hooks can also be set up to run\nasynchronously in the same fashion:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'async tests'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Before Hooks</span>\n  <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Tests</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should foo'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should bar'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// After Hooks</span>\n  <span class=\"token function\">afterEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The above code will take approximately 8 seconds to run and will follow a\nserial execution path as such:</p>\n<ul>\n<li><code class=\"language-text\">before</code></li>\n<li><code class=\"language-text\">beforeEach</code></li>\n<li><code class=\"language-text\">it</code> should foo</li>\n<li><code class=\"language-text\">afterEach</code></li>\n<li><code class=\"language-text\">beforeEach</code></li>\n<li><code class=\"language-text\">it</code> should bar</li>\n<li><code class=\"language-text\">afterEach</code></li>\n<li><code class=\"language-text\">after</code></li>\n</ul>\n<p>Of course, you can mix synchronous and asynchronous hooks and tests and\neverything will run serially with no extra effort.</p>\n<p>You may have noticed that I haven't been making any assertions. That is\nbecause Mocha is designed to let you use your own assertions library. Node\nprovides an <code class=\"language-text\">assert</code> module, but we want to use the same tests and assertions\nin all of our environments, not just Node. This is where <a href=\"http://chaijs.com/\" title=\"Chai\">Chai</a> comes\nin.</p>\n<h2>Chai</h2>\n<p><a href=\"http://chaijs.com/\" title=\"Chai\">Chai</a> is an assertions library which provides multiple styles of\nassertions for your to use as you see fit. I prefer\n<a href=\"http://chaijs.com/api/bdd/\"><code class=\"language-text\">expect</code></a>-style assertions which read like\nsentences. See the following examples:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'three'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>deep<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">instanceOf</span><span class=\"token punctuation\">(</span>Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>As you can see, the <code class=\"language-text\">expect</code> style of assertions are very readable and even\nself-documenting. The lack of parentheses after <code class=\"language-text\">true</code> in <code class=\"language-text\">to.be.true</code> is not\na mistake. Chai's <code class=\"language-text\">expect</code> style makes use of <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Working_with_Objects#Defining_getters_and_setters\" title=\"Defining Getters and Setters\">JavaScript getters and\nsetters</a> meaning <code class=\"language-text\">to.be.true</code> is not a function, but a property getter.\nIf you need to support an environment which does not support getters and\nsetters, you will have to use <code class=\"language-text\">to.equal(true)</code> or another assertions library\nwhich is purely functional.</p>\n<p>Obviously, the above sample does not cover everything you can do in Chai.\nThere is a <a href=\"http://chaijs.com/api/bdd/\" title=\"Chai BDD API\">list of all available chains and assertions</a> available\nthrough <a href=\"http://chaijs.com/\" title=\"Chai\">Chai's documentation</a>. The assertions provided by Chai cover\neverything you may want to assert, including (deep) (in)equality, inclusion,\nexistence, ranges, regular expression matching, and (static) method\nrespondence. Additional functionality which extends the core of Chai is\navailable in community-provided <a href=\"http://chaijs.com/plugins\" title=\"Chai Plugins\">plugins</a>.</p>\n<h2>Sinon</h2>\n<p>On to everybody's favorite topic: mocking! <a href=\"http://sinonjs.org/\" title=\"Sinon\">Sinon</a> is a library which\nprovides spies, stubs, and mocks for JavaScript. Let's cover each of those in\norder.</p>\n<h3>Spies</h3>\n<p>A <a href=\"http://sinonjs.org/docs/#spies\" title=\"Sinon Spies API\"><code class=\"language-text\">spy</code></a> is a function which automatically records various metrics\nregarding its execution including arguments passed to it, return value, the\nvalue of <code class=\"language-text\">this</code>, and any exceptions thrown for all of its calls. See the\nfollowing example:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> func <span class=\"token operator\">=</span> sinon<span class=\"token punctuation\">.</span><span class=\"token function\">spy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">func</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span>called<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// The following two assertions are identical</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span>calledOnce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span>callCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// The following two assertions are identical</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span>firstCall<span class=\"token punctuation\">.</span><span class=\"token function\">calledWith</span><span class=\"token punctuation\">(</span>sinon<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span> sinon<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span><span class=\"token function\">getCall</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">calledWith</span><span class=\"token punctuation\">(</span>sinon<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span> sinon<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// You can even verify that a function was called with specific arguments (not just types)</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span>firstCall<span class=\"token punctuation\">.</span><span class=\"token function\">calledWith</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>As you can see, Sinon spies are extremely flexible. This example only begins\nto scratch the surface of spies in Sinon. <code class=\"language-text\">calledOnce</code> is accompanied by\n<code class=\"language-text\">calledTwice</code> and <code class=\"language-text\">calledThrice</code> which are all aliases for checking the\n<code class=\"language-text\">callCount</code>. In addition to <code class=\"language-text\">firstCall</code>, Sinon spies provide <code class=\"language-text\">secondCall</code> and\n<code class=\"language-text\">thirdCall</code> properties which are all aliases for <code class=\"language-text\">getCall(0)</code>, <code class=\"language-text\">getCall(1)</code>,\nand <code class=\"language-text\">getCall(2)</code>, respectively. Anything beyond the third call must be\naccessed with <code class=\"language-text\">getCall(n)</code> where <code class=\"language-text\">n</code> is the number call you want to access.\nCalls can additionally be inspected, in this case to make sure they were\ncalled with a <code class=\"language-text\">number</code> and a <code class=\"language-text\">string</code>. Sinon provides even more matchers for\nthe following situations:</p>\n<ul>\n<li>All basic JavaScript primitives</li>\n<li>Truthy / falsy values</li>\n<li>Referential equality to a given object</li>\n<li>Making sure an argument is an instance of a particular constructor</li>\n<li>Making sure an argument has a property (or its own property) which\noptionally match additional expectations</li>\n</ul>\n<p>Matchers can even be combined; for example, you can check to make sure an\nargument is either a <code class=\"language-text\">string</code> or a <code class=\"language-text\">number</code>. To learn more about this\nfunctionality check out Sinon's <a href=\"http://sinonjs.org/docs/#sinon-match\" title=\"Sinon Matchers API\">matchers documentation</a>.</p>\n<p>Spies can wrap themselves around existing methods on existing methods.\nConsider the following example utilizing <a href=\"http://jquery.com\" title=\"jQuery\">jQuery</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Spy on the `ajax` method of the `jQuery` object</span>\nsinon<span class=\"token punctuation\">.</span><span class=\"token function\">spy</span><span class=\"token punctuation\">(</span>jQuery<span class=\"token punctuation\">,</span> <span class=\"token string\">'ajax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Call `jQuery.get(...)` which calls `jQuery.ajax` down the chain</span>\njQuery<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/some/resource'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Assert that `jQuery.ajax` was called with the given url.</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>jQuery<span class=\"token punctuation\">.</span>ajax<span class=\"token punctuation\">.</span>calledOnce<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>jQuery<span class=\"token punctuation\">.</span>ajax<span class=\"token punctuation\">.</span><span class=\"token function\">getCall</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/some/resource'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Unwrap `jQuery.ajax` so other tests will be unaffected and can get up their own spies</span>\njQuery<span class=\"token punctuation\">.</span>ajax<span class=\"token punctuation\">.</span><span class=\"token function\">restore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In this example I referenced the passed argument directly and checked a\nproperty on it for equality to what was passed. I also called the <code class=\"language-text\">restore()</code>\nmethod on the spy to return <code class=\"language-text\">jQuery.ajax</code> to its original functionality. This\nis an important step in testing (often run in <code class=\"language-text\">after</code> or <code class=\"language-text\">afterEach</code> hooks) to\nmake sure tests and their spies do not interfere with each other.</p>\n<p>For more information on spy functionality in Sinon, including verifying order\nof calls to multiple spies, check out the <a href=\"http://sinonjs.org/docs/#spies\" title=\"Sinon Spies API\">Sinon spy documentation</a>.</p>\n<h3>Stubs</h3>\n<p>A <a href=\"http://sinonjs.org/docs/#stubs\" title=\"Sinon Stubs API\"><code class=\"language-text\">stub</code></a> is a <a href=\"http://sinonjs.org/docs/#spies\" title=\"Sinon Spies API\"><code class=\"language-text\">spy</code></a> with pre-programmed functionality. You\nshould use a stub when you need to control the behavior of a function you are\nspying on. You can very easily program a stub to throw an exception, return a\ngiven value, return and argument which was passed to it, or even call an\nargument which was passed to it -- with or without arguments, synchronously or\nasynchronously. Stubs can even be programmed to do different things when\ndifferent arguments are passed to them. Consider the following example:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> func <span class=\"token operator\">=</span> sinon<span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfunc<span class=\"token punctuation\">.</span><span class=\"token function\">withArgs</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">returns</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfunc<span class=\"token punctuation\">.</span><span class=\"token function\">throws</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token function\">func</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">throw</span><span class=\"token punctuation\">(</span>Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When <code class=\"language-text\">func</code> is passed <code class=\"language-text\">42</code>, it will return <code class=\"language-text\">1</code>. Otherwise, it will throw an\nexception.</p>\n<p>Just like how you can spy on methods of objects, you can stub methods of\nobjects. Consider the following example of stubbing the <code class=\"language-text\">readFile</code> method on\nNode's filesystem module:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Stub the file system module</span>\nsinon<span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">,</span> <span class=\"token string\">'readFile'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Asynchronously call the third argument with a null error and some text when passed certain arguments</span>\nfs<span class=\"token punctuation\">.</span>readFile\n  <span class=\"token punctuation\">.</span><span class=\"token function\">withArgs</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span> sinon<span class=\"token punctuation\">.</span>matchers<span class=\"token punctuation\">.</span>func<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">callsArgWithAsync</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Foo!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Asynchronously call the third argument with an error when passed certain arguments</span>\nfs<span class=\"token punctuation\">.</span>readFile\n  <span class=\"token punctuation\">.</span><span class=\"token function\">withArgs</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bar.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span> sinon<span class=\"token punctuation\">.</span>matchers<span class=\"token punctuation\">.</span>func<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">callsArgWithAsync</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'File not found!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Do your testing</span>\n<span class=\"token comment\">// Afterwards make sure you restore `fs.readFile` to its original functionality.</span>\nfs<span class=\"token punctuation\">.</span>readFile<span class=\"token punctuation\">.</span><span class=\"token function\">restore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now everything that calls <code class=\"language-text\">fs.readFile(&#39;foo.txt&#39;, &#39;utf8&#39;, callback)</code> will have\n<code class=\"language-text\">callback</code> called with <code class=\"language-text\">null</code> for an error and <code class=\"language-text\">&#39;Foo!&#39;</code> for data and\neverything that calls <code class=\"language-text\">fs.readFile(&#39;bar.txt&#39;, &#39;utf8&#39;, callback)</code> will have\n<code class=\"language-text\">callback</code> called with an <code class=\"language-text\">Error</code> object. The <code class=\"language-text\">callback</code>s are called\nasynchronously so all other functionality of your program is preserved, but\nyour tests are no longer dependent on the file system. Stubbing methods which\nrely on external resources such as file systems or network connections is very\ncommon in testing as your tests will run faster and will be more portable\noverall.</p>\n<p>To learn more about Sinon stubs, read the <a href=\"http://sinonjs.org/docs/#stubs\" title=\"Sinon Stubs API\">Sinon stub documentation</a>.</p>\n<h3>Mocks</h3>\n<p><a href=\"http://sinonjs.org/docs/#mocks\" title=\"Sinons Mocks API\">Mocks</a> provide fake methods with pre-programmed functionality and with\npre-programmed expectations. For example, you can program a mock to expect a\ncertain number of calls, at most a certain number of calls, at least a certain\nnumber of calls, to never be called, to be called with certain arguments, and\nmore. After your test is done you can call your mock's <code class=\"language-text\">verify</code> method which\nwill throw an exception if the preset expectations are not met. To learn more\nabout mocks and expectations in Sinon you can read <a href=\"http://sinonjs.org/docs/#mocks\" title=\"Sinons Mocks API\">Sinon's mock\ndocumentation</a>.</p>\n<h3>Chai Assertions</h3>\n<p>Sinon provides its own assertions. Despite this, for the sake of consistency,\nI was using Chai assertions in the examples above. There is a plugin available\nfor Chai which can streamline expectations for Sinon spies, stubs, and mocks.\nUsing the plugin, my first Sinon example from above would look like the\nfollowing:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> func <span class=\"token operator\">=</span> sinon<span class=\"token punctuation\">.</span><span class=\"token function\">spy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">func</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>have<span class=\"token punctuation\">.</span>been<span class=\"token punctuation\">.</span>called<span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>have<span class=\"token punctuation\">.</span>been<span class=\"token punctuation\">.</span>calledOnce<span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>have<span class=\"token punctuation\">.</span>been<span class=\"token punctuation\">.</span><span class=\"token function\">calledWith</span><span class=\"token punctuation\">(</span>sinon<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span> sinon<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">.</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>have<span class=\"token punctuation\">.</span>been<span class=\"token punctuation\">.</span><span class=\"token function\">calledWith</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>For more information, check out the <a href=\"http://chaijs.com/plugins/sinon-chai\" title=\"Sinon-Chai Plugin Documentation\">Sinon-Chai plugin\ndocumentation</a>.</p>\n<h3>More Sinon Functionality</h3>\n<p>Sinon provides a plethora of other features specific to JavaScript including\nfake timers, fake <code class=\"language-text\">XMLHttpRequest</code>s, and fake servers. To learn more about\nthese features take a look at <a href=\"http://sinonjs.org/docs\" title=\"Sinon Official Documentation\">Sinon's official\ndocumentation</a>.</p>\n<h2>Testem</h2>\n<p>This is where we tie everything together. <a href=\"https://github.com/airportyh/testem\" title=\"Testem\">Testem</a> is a test runner\nwhich can automatically run tests in multiple web browsers and other\nenvironments such as Node. By default tests will run when you connect a\nbrowser or other environment and can be rerun in all connected environments\nwith the press of a button. By default, tests are also automatically rerun\nwhen a change is detected on the file system. Testem is even capable of giving\nyou native system notifications meaning you can just code away in your\nfavorite editor and immediately see test results upon saving without having to\ndo anything.</p>\n<p>Testem provides default HTML pages for running and auto-rerunning as well as\ncollecting test results. Setting it up to run tests in Node requires a little\nbit of set up; however, it is entirely worth it, trust me. Once everything is\nset up not only are tests run automatically but all results are collected\ncentrally so you can instantly see what happened where. In order to streamline\nthis process I have made a <a href=\"https://github.com/KenPowers/testing-in-browsers-and-node\" title=\"GitHub Project\">project available on github</a>.</p>\n<p>First, you need to install <a href=\"http://nodejs.org\" title=\"Node\">Node</a>. My preferred method is to use\n<a href=\"https://github.com/creationix/nvm\" title=\"Node Version Manager\">nvm</a> but you can set it up however you like.</p>\n<p>Next, clone the project down to your local workspace, change into the project\ndirectory, and install all dependencies using the following commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ git clone https://github.com/KenPowers/testing-in-browsers-and-node.git\n$ cd testing-in-browsers-and-node\n$ npm install</code></pre></div>\n<p>Optionally, you can install Testem and Mocha globally (they are both installed\nlocally as a part of the project, but installing them globally will allow you\nto use them elsewhere):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ npm install -g testem mocha</code></pre></div>\n<p>Be aware that as of the writing of this article, if you are running Windows\nthen you will need to <a href=\"https://github.com/airportyh/testem#known-issues\" title=\"Windows Workaround\">follow one extra step</a>.</p>\n<p>Now we can take a look at how everything works together. First, <code class=\"language-text\">testem.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"framework\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mocha\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"src_files\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"node_modules/chai/chai.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"lib/*\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"test/setup.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"test/*.test.js\"</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"launchers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"node\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"command\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./node_modules/.bin/mocha -r test/setup.js -R tap test/*.test.js\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"protocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tap\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"launch_in_dev\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"node\"</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let's walk through this file key-by-key. First we have the <code class=\"language-text\">framework</code> option\nset to <code class=\"language-text\">mocha</code>. This tells Testem to load Mocha into all connected web\nbrowsers. Next we have a <code class=\"language-text\">src_files</code> option. These are the files which are\nmonitored for changes as well as served (in order) to all connected web\nbrowsers. We explicity list <code class=\"language-text\">test/setup.js</code> before <code class=\"language-text\">*.test.js</code> to make sure\nour setup file is served and executed before the tests. Next, we set up\nlaunching tests in Node. This is required because by default Testem just sets\nup a server for browsers to connect to. All we need to do to get Node working\nwith Testem is get it running in a similar setup that the browsers will have.\nThe command <code class=\"language-text\">./node_modules/.bin/mocha -r test/setup.js -R tap test/*.test.js</code>\nruns Mocha (node) telling it to require the file <code class=\"language-text\">test/setup.js</code>, use\n<a href=\"http://en.wikipedia.org/wiki/Test_Anything_Protocol\" title=\"Test Anything Protocol\">tap</a> as the protocol (so Testem can read the results), and run all files\nmatching the pattern <code class=\"language-text\">test/*.test.js</code> as tests. If you have Mocha installed\nglobally then you can simply use <code class=\"language-text\">mocha</code> instead of\n<code class=\"language-text\">./node_modules/.bin/mocha</code>. <em>Finally</em>, <code class=\"language-text\">launch_in_dev</code> tells Testem to run\nour Node launcher.</p>\n<p>Now we just have to take a look at one section of <code class=\"language-text\">package.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./node_modules/.bin/testem\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>With this piece of configuration you can run <code class=\"language-text\">npm test</code> which will run the\nlocal installation of Testem which will read <code class=\"language-text\">testem.json</code> and start running\nthe tests. Alternatively, if you have <code class=\"language-text\">testem</code> installed globally then you can\njust run <code class=\"language-text\">testem</code> directly.</p>\n<p>One last file needs a walk though: <code class=\"language-text\">test/setup.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Export modules to global scope as necessary (only for testing)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> process <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span> <span class=\"token operator\">&amp;&amp;</span> process<span class=\"token punctuation\">.</span>title <span class=\"token operator\">===</span> <span class=\"token string\">'node'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// We are in node. Require modules.</span>\n  expect <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chai'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>expect<span class=\"token punctuation\">;</span>\n  sinon <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sinon'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  num <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  isBrowser <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// We are in the browser. Set up variables like above using served js files.</span>\n  expect <span class=\"token operator\">=</span> chai<span class=\"token punctuation\">.</span>expect<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// num and sinon already exported globally in the browser.</span>\n  isBrowser <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This file exports the libraries we are using as global variables. I know what\nyou are thinking: \"NO! NOT GLOBAL VARIABLES! GLOBAL VARIABLES ARE EVIL!\" The\ntruth of the matter is that when we are testing in multiple environments there\nare different ways to load these dependencies -- we can either do this for\neach test suite or we can do it once up front. Take your pick. This file\nadditionally sets a boolean value <code class=\"language-text\">isBrowser</code> which you can use in the tests\nif you need to test things differently in browsers than you do in Node. You\ncan even set up tests to only run in certain environments by using code like\nthe following:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'multi-environment testing'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isBrowser<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should foo'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// This test will only run in browsers.</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should bar'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// This test will only run in Node.</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'shold baz'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This test will run everywhere.</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Take a moment to look through the other files included in the project. There\nis no need to walk through them here because after reading this article their\ncontents should be fairly intuitive. That being said, let's do a quick rundown\nof each file. <code class=\"language-text\">lib/num.js</code> contains a basic math library. It has a <code class=\"language-text\">square</code>\nmethod, which squares a given number, and a <code class=\"language-text\">squareRandomNumber</code> method, which\ndepends on a method that asynchronously retrieves a random number.\n<code class=\"language-text\">test/num.test.js</code> tests each of the previously mentioned methods, making use\nof assertions and stubs as necessary.</p>\n<p>Go ahead and run either <code class=\"language-text\">npm test</code> (or <code class=\"language-text\">testem</code> if you installed globally)\nnow.</p>\n<p>Now that Testem is running you'll see a few things. One thing you'll see is a\ntab with the test results for node. Another thing you'll see is a URL you can\nvisit to connect a web browser for testing. After opening the URL in a few web\nbrowsers Testem should look like the following:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aaf20e22b93549b6cef52f64e0da7a3c/b94e3/testem.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6UlEQVQoz93SXWuDMBQG4NxNWyI1utXRQhEK263aqo0mJxo/Urfp6P7/f5nO9qLgtu528BBeDjmB5AQ9HU8b+bat3p+b0wqO5CDvk8qipRnLh7RaRLnu81kwDblF59bt9rVzy24tG5sVOAK8F/1qxALHoAf8O0j3GGkTo6TmLic5t1+4KQCHYNdgKzAzMCIxnDUFYVou8gYnaqk+HNlaVJJDYdEvSUHiS56C5nsxD7NBf70d6D67HZr57ErAb4f+tPufNGte2rvz0vEBNY9p5zBUfml2mFqyep014+gcrsbwyJURih/+Zu8TcyR6OgPVL2UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Testem Screenshot\"\n        title=\"Testem Screenshot\"\n        src=\"/static/aaf20e22b93549b6cef52f64e0da7a3c/a6d36/testem.png\"\n        srcset=\"/static/aaf20e22b93549b6cef52f64e0da7a3c/222b7/testem.png 163w,\n/static/aaf20e22b93549b6cef52f64e0da7a3c/ff46a/testem.png 325w,\n/static/aaf20e22b93549b6cef52f64e0da7a3c/a6d36/testem.png 650w,\n/static/aaf20e22b93549b6cef52f64e0da7a3c/e548f/testem.png 975w,\n/static/aaf20e22b93549b6cef52f64e0da7a3c/b94e3/testem.png 1126w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>By using the left and right arrow keys you can see test results and error\nmessages for all browsers and connected launchers. Pressing <code class=\"language-text\">enter</code> will rerun\ntests in all connected environments, and pressing <code class=\"language-text\">q</code> will quit Testem.</p>\n<p>Try making a change to <code class=\"language-text\">lib/num.js</code> that you think will make one or more of\nthe tests fail. You should see Testem automatically rerun the tests and\nfurther see which tests failed in which environments.</p>\n<h2>Other features in Testem</h2>\n<p>Testem does more than just run tests in multiple environments very easily. You\ncan specify preprocessors that run before tests run (e.g., compiling\nCoffeeScript or running a CSS preprocessor), separate source files (monitored\nfor changes) and served files (not monitored for changes), and more (such as\nthe previously mentioned system notifications). To learn about these features\ntake a look at <a href=\"https://github.com/airportyh/testem\" title=\"Testem\">Testem's documentation</a>.</p>\n<h2>Conclusion</h2>\n<p>This article is meant to get you familiar with the basics of multi-environment\ntesting in JavaScript. More articles about each of the above projects\nfeaturing more advanced features are in the pipeline. In the meantime, you can\nread the official documentation of each project here:</p>\n<ul>\n<li><a href=\"http://visionmedia.github.io/mocha/\" title=\"Mocha\">Mocha</a></li>\n<li><a href=\"http://chaijs.com/\" title=\"Chai\">Chai</a></li>\n<li><a href=\"http://sinonjs.org/\" title=\"Sinon\">Sinon</a></li>\n<li><a href=\"https://github.com/airportyh/testem\" title=\"Testem\">Testem</a></li>\n</ul>","id":"43b21bbf-4816-56a3-8489-e0ddcd14433f","timeToRead":15,"frontmatter":{"date":"December 03, 2013","path":"/blog/testing-in-browsers-and-node","tags":"javascript, testing, node, browser","title":"Testing in Browsers and Node with Mocha, Chai, Sinon, and Testem"}}],"tag":"node","pagesSum":1,"page":1}}}